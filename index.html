<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monthly Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      padding: 1.5rem 1.25rem 2.5rem;
    }

    .card {
      background: #020617;
      border-radius: 1.25rem;
      padding: 1.5rem 1.75rem 1.25rem;
      box-shadow: 0 28px 60px rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
    }

    header {
      display:flex;
      justify-content:space-between;
      gap:1rem;
      align-items:flex-start;
      border-bottom:1px solid #111827;
      padding-bottom:0.75rem;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      padding:0.25rem 0.6rem;
      border-radius:999px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.9);
      font-size:0.7rem;
      color:#9ca3af;
    }

    .pill-dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      margin-top: 1rem;
    }

    .top-bar-left {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.25rem;
    }

    select, input[type="month"], input[type="date"], input[type="text"], input[type="number"] {
      background: #020617;
      color: #e5e7eb;
      border-radius: 0.6rem;
      border: 1px solid #374151;
      padding: 0.45rem 0.6rem;
      font-size: 0.85rem;
      min-width: 0;
      width:100%;
      box-sizing:border-box;
    }

    select:focus, input:focus {
      outline: 2px solid #2563eb;
      outline-offset: 1px;
      border-color: #2563eb;
    }

    .field-group {
      display:flex;
      flex-direction:column;
      min-width:8rem;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.45rem 0.9rem;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      border-color: transparent;
    }

    .btn-ghost {
      background: transparent;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: default;
    }

    .btn-small {
      padding: 0.35rem 0.7rem;
      font-size: 0.75rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.25fr 1.75fr;
      gap: 1.1rem;
      margin-top: 1.15rem;
    }

    @media (max-width: 850px) {
      .layout {
        grid-template-columns: 1fr;
      }

      header {
        flex-direction:column;
        align-items:flex-start;
      }
    }

    .summary-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    @media (max-width: 540px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-card {
      background: radial-gradient(circle at top left, rgba(37,99,235,0.4), transparent 50%);
      border-radius: 0.9rem;
      padding: 0.8rem 0.9rem;
      border: 1px solid #1f2937;
      position:relative;
      overflow:hidden;
    }

    .summary-card:nth-child(2) {
      background: radial-gradient(circle at top left, rgba(22,163,74,0.4), transparent 50%);
    }
    .summary-card:nth-child(3) {
      background: radial-gradient(circle at top left, rgba(244,114,182,0.4), transparent 50%);
    }
    .summary-card:nth-child(4) {
      background: radial-gradient(circle at top left, rgba(234,179,8,0.4), transparent 50%);
    }

    .summary-title {
      font-size: 0.78rem;
      color: #9ca3af;
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    .summary-value {
      font-size: 1.25rem;
      font-weight: 600;
      margin-top: 0.18rem;
    }

    .summary-sub {
      font-size: 0.74rem;
      color: #cbd5f5;
      margin-top: 0.12rem;
    }

    .summary-chip {
      position:absolute;
      right:0.7rem;
      bottom:0.6rem;
      font-size:0.7rem;
      padding:0.15rem 0.5rem;
      border-radius:999px;
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(148,163,184,0.4);
      color:#9ca3af;
    }

    .section-title {
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:#6b7280;
      margin-bottom:0.35rem;
    }

    .form {
      margin-top: 0.75rem;
      border-radius: 0.9rem;
      border: 1px dashed #374151;
      padding: 0.8rem;
      background: rgba(15,23,42,0.8);
    }

    .form-row {
      display: grid;
      gap: 0.5rem;
    }

    @media (min-width: 700px) {
      .form-row {
        grid-template-columns: 0.8fr 0.9fr 1.1fr 0.8fr 0.7fr;
      }
    }

    .form-actions {
      margin-top: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .form-note {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .table-card {
      border-radius:0.9rem;
      border:1px solid #111827;
      background:#020617;
      padding:0.75rem;
    }

    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      margin-top: 0.4rem;
      border-radius: 0.6rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      padding: 0.45rem 0.35rem;
      text-align: left;
      border-bottom: 1px solid #111827;
    }

    th {
      font-size: 0.74rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.9);
    }

    .type-pill {
      font-size:0.7rem;
      padding:0.15rem 0.4rem;
      border-radius:999px;
      border:1px solid;
    }
    .type-expense { border-color:rgba(248,113,113,0.7); color:#fecaca; background:rgba(127,29,29,0.35); }
    .type-income { border-color:rgba(52,211,153,0.7); color:#bbf7d0; background:rgba(6,78,59,0.4); }
    .type-saving { border-color:rgba(251,191,36,0.7); color:#fef9c3; background:rgba(133,77,14,0.4); }

    .category-pill {
      font-size: 0.7rem;
      padding: 0.18rem 0.4rem;
      border-radius: 999px;
      background: rgba(37,99,235,0.15);
      border: 1px solid rgba(37,99,235,0.3);
      color: #bfdbfe;
    }

    .meta {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.9rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: space-between;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 0.3rem;
    }

    .status-ok { background:#22c55e; }
    .status-syncing { background:#fbbf24; }
    .status-error { background:#ef4444; }

    .status-text {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .badge-cloud {
      font-size: 0.68rem;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.9);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: #9ca3af;
    }

    .toolbar-right {
      display:flex;
      flex-direction:column;
      gap:0.4rem;
      align-items:flex-end;
    }

    @media (max-width:650px) {
      .toolbar-right {
        align-items:flex-start;
      }
    }
  </style>

  <!-- MSAL for Microsoft login -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div>
          <h1>Monthly Expense Tracker</h1>
          <div class="subtitle">
            Track income, expenses & savings with optional OneDrive sync.
          </div>
        </div>
        <div class="pill">
          <span class="pill-dot"></span>
          <span>Data stays with your Microsoft account</span>
        </div>
      </header>

      <div class="top-bar">
        <div class="top-bar-left">
          <div class="field-group">
            <label for="monthSelect">Month</label>
            <input type="month" id="monthSelect" />
          </div>
          <button class="btn btn-small" id="prevMonthBtn">&larr; Previous</button>
          <button class="btn btn-small" id="nextMonthBtn">Next &rarr;</button>
        </div>

        <div class="toolbar-right">
          <div style="display:flex; gap:0.45rem; flex-wrap:wrap;">
            <button class="btn btn-small btn-primary" id="signInBtn">Sign in with Microsoft</button>
            <button class="btn btn-small btn-ghost" id="signOutBtn" style="display:none;">Sign out</button>
          </div>
          <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap;">
            <button class="btn btn-small" id="syncNowBtn" disabled>Sync now</button>
            <span class="badge-cloud">
              ☁ OneDrive sync
            </span>
          </div>
        </div>
      </div>

      <div class="layout">
        <!-- LEFT: Summary + form -->
        <section>
          <div class="section-title">Overview</div>
          <div class="summary-grid" id="summary"></div>

          <form class="form" id="entryForm">
            <div class="section-title" style="margin-bottom:0.35rem;">Add entry</div>
            <div class="form-row">
              <div class="field-group">
                <label for="dateInput">Date</label>
                <input type="date" id="dateInput" required />
              </div>
              <div class="field-group">
                <label for="typeInput">Type</label>
                <select id="typeInput">
                  <option value="expense">Expense</option>
                  <option value="income">Income</option>
                  <option value="saving">Saving</option>
                </select>
              </div>
              <div class="field-group">
                <label for="categoryInput">Category</label>
                <select id="categoryInput">
                  <option>General</option>
                  <option>Food</option>
                  <option>Transport</option>
                  <option>Housing</option>
                  <option>Utilities</option>
                  <option>Shopping</option>
                  <option>Entertainment</option>
                  <option>Health</option>
                  <option>Salary</option>
                  <option>Business</option>
                  <option>Investment</option>
                  <option>Savings</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="field-group">
                <label for="descriptionInput">Description</label>
                <input type="text" id="descriptionInput" placeholder="e.g. Groceries / Salary" />
              </div>
              <div class="field-group">
                <label for="amountInput">Amount</label>
                <input type="number" id="amountInput" step="0.01" min="0" required />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                + Add entry
              </button>
              <div class="form-note">
                Local autosave. When signed in, you can sync to OneDrive so all devices share the same data.
              </div>
            </div>
          </form>
        </section>

        <!-- RIGHT: Table -->
        <section>
          <div class="table-card">
            <div class="section-title">Month entries</div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th style="text-align:right;">Amount</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="entryTableBody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <div class="meta">
        <div class="status-text" id="syncStatus">
          <span class="status-dot status-ok" id="statusDot"></span>
          <span id="statusLabel">Local only · not signed in</span>
        </div>
        <div style="display:flex; gap:0.4rem; flex-wrap:wrap;">
          <button class="btn btn-small" id="exportBtn">Export backup</button>
          <input type="file" id="importFileInput" accept="application/json" style="display:none;" />
          <button class="btn btn-small" id="importBtn">Import backup</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LOCAL_STORAGE_KEY = "expense_tracker_data_v2";
    const CLOUD_FILE_NAME = "expense-tracker-data.json";

    let state = {
      entries: [],
      lastSyncedAt: null,
      cloudEnabled: false,
      msAccount: null,
      syncing: false
    };

    function loadLocalData() {
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed.entries)) {
          state.entries = parsed.entries.map(e => ({
            ...e,
            type: e.type || "expense"
          }));
        }
        state.lastSyncedAt = parsed.lastSyncedAt || null;
      } catch (e) {
        console.error("Failed to parse local data", e);
      }
    }

    function saveLocalData() {
      const payload = {
        entries: state.entries,
        lastSyncedAt: state.lastSyncedAt
      };
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(payload));
    }

    function addEntry({ date, type, category, description, amount }) {
      state.entries.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        date,
        type: type || "expense",
        category,
        description: description || "",
        amount: Number(amount) || 0
      });
      saveLocalData();
      render();
    }

    function deleteEntry(id) {
      state.entries = state.entries.filter(e => e.id !== id);
      saveLocalData();
      render();
    }

    function getCurrentMonthKey() {
      const monthInput = document.getElementById("monthSelect");
      return monthInput.value;
    }

    function getEntriesForCurrentMonth() {
      const key = getCurrentMonthKey();
      if (!key) return [];
      return state.entries.filter(e => (e.date || "").startsWith(key));
    }

    function formatCurrency(value) {
      const num = Number(value) || 0;
      return num.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function renderSummary() {
      const container = document.getElementById("summary");
      const list = getEntriesForCurrentMonth();

      const income = list.filter(e => e.type === "income").reduce((s,e) => s + e.amount, 0);
      const expenses = list.filter(e => e.type === "expense").reduce((s,e) => s + e.amount, 0);
      const savings = list.filter(e => e.type === "saving").reduce((s,e) => s + e.amount, 0);
      const net = income - expenses - savings;

      const expenseCount = list.filter(e => e.type === "expense").length;

      const byCategory = {};
      for (const e of list.filter(e => e.type === "expense")) {
        byCategory[e.category] = (byCategory[e.category] || 0) + e.amount;
      }
      const topCategory = Object.entries(byCategory).sort((a,b) => b[1] - a[1])[0];

      container.innerHTML = `
        <div class="summary-card">
          <div class="summary-title">Income</div>
          <div class="summary-value">$${formatCurrency(income)}</div>
          <div class="summary-sub">Money coming in this month</div>
          <span class="summary-chip">${income ? "Good flow" : "No income yet"}</span>
        </div>
        <div class="summary-card">
          <div class="summary-title">Expenses</div>
          <div class="summary-value">$${formatCurrency(expenses)}</div>
          <div class="summary-sub">${expenseCount} expense item${expenseCount === 1 ? "" : "s"}</div>
          <span class="summary-chip">${topCategory ? topCategory[0] : "Top category —"}</span>
        </div>
        <div class="summary-card">
          <div class="summary-title">Savings</div>
          <div class="summary-value">$${formatCurrency(savings)}</div>
          <div class="summary-sub">Total saved / set aside</div>
          <span class="summary-chip">${savings ? "Nice!" : "Add a saving entry"}</span>
        </div>
        <div class="summary-card">
          <div class="summary-title">Net balance</div>
          <div class="summary-value" style="color:${net >= 0 ? "#4ade80" : "#fca5a5"};">
            $${formatCurrency(net)}
          </div>
          <div class="summary-sub">
            Income – expenses – savings
          </div>
          <span class="summary-chip">${net >= 0 ? "Positive" : "Negative"}</span>
        </div>
      `;
    }

    function renderTable() {
      const tbody = document.getElementById("entryTableBody");
      const list = getEntriesForCurrentMonth().sort((a, b) => (a.date || "").localeCompare(b.date || ""));
      if (!list.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align:center; color:#6b7280; padding:1.5rem;">
              No entries for this month yet. Add your first income, expense, or saving above.
            </td>
          </tr>
        `;
        return;
      }
      tbody.innerHTML = list.map(e => {
        const safeDescription = e.description ? e.description.replace(/</g,"&lt;") : "";
        const typeClass = e.type === "income" ? "type-income" : e.type === "saving" ? "type-saving" : "type-expense";
        const typeLabel = e.type.charAt(0).toUpperCase() + e.type.slice(1);
        return `
        <tr>
          <td>${e.date || ""}</td>
          <td><span class="type-pill ${typeClass}">${typeLabel}</span></td>
          <td><span class="category-pill">${e.category || "General"}</span></td>
          <td>${safeDescription}</td>
          <td style="text-align:right;">$${formatCurrency(e.amount)}</td>
          <td style="text-align:right;">
            <button class="btn btn-small" onclick="handleDeleteEntry('${e.id}')">✕</button>
          </td>
        </tr>
      `;
      }).join("");
    }

    function renderSyncStatus() {
      const statusDot = document.getElementById("statusDot");
      const label = document.getElementById("statusLabel");
      const syncBtn = document.getElementById("syncNowBtn");
      const signInBtn = document.getElementById("signInBtn");
      const signOutBtn = document.getElementById("signOutBtn");

      if (state.syncing) {
        statusDot.className = "status-dot status-syncing";
        label.textContent = "Syncing with OneDrive…";
        syncBtn.disabled = true;
        return;
      }

      if (state.msAccount) {
        syncBtn.disabled = false;
        statusDot.className = "status-dot status-ok";
        const when = state.lastSyncedAt
          ? new Date(state.lastSyncedAt).toLocaleString()
          : "Not yet synced";
        label.textContent = `Signed in as ${state.msAccount.username || state.msAccount.name || "account"} · Last sync: ${when}`;
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-flex";
      } else {
        syncBtn.disabled = true;
        statusDot.className = "status-dot status-ok";
        label.textContent = "Local only · not signed in";
        signInBtn.style.display = "inline-flex";
        signOutBtn.style.display = "none";
      }
    }

    function render() {
      renderSummary();
      renderTable();
      renderSyncStatus();
    }

    window.handleDeleteEntry = function(id) {
      if (confirm("Delete this entry?")) {
        deleteEntry(id);
      }
    };

    // ********** MSAL + OneDrive config – you still need to plug your CLIENT_ID later **********
    const CLIENT_ID = "YOUR_CLIENT_ID_HERE";
    const REDIRECT_URI = "https://aalinoor307.github.io/expense-tracker.html/";

    const msalConfig = {
      auth: {
        clientId: CLIENT_ID,
        authority: "https://login.microsoftonline.com/common",
        redirectUri: REDIRECT_URI
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };

    const loginRequest = { scopes: ["User.Read", "Files.ReadWrite"] };
    const graphBase = "https://graph.microsoft.com/v1.0";
    let msalInstance = null;

    function initMsal() {
      if (!CLIENT_ID || CLIENT_ID === "YOUR_CLIENT_ID_HERE") {
        console.warn("CLIENT_ID not set – Microsoft sign-in disabled.");
        return;
      }
      try {
        msalInstance = new msal.PublicClientApplication(msalConfig);
        msalInstance.handleRedirectPromise().then((response) => {
          if (response && response.account) {
            msalInstance.setActiveAccount(response.account);
            state.msAccount = response.account;
          } else {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
              msalInstance.setActiveAccount(accounts[0]);
              state.msAccount = accounts[0];
            }
          }
          if (state.msAccount) {
            state.cloudEnabled = true;
            renderSyncStatus();
            syncFromCloud();
          }
        }).catch((error) => {
          console.error("MSAL redirect error", error);
        });
      } catch (e) {
        console.warn("MSAL init failed", e);
      }
    }

    async function signIn() {
      if (!msalInstance) {
        alert("Cloud sync not configured yet. Please set your CLIENT_ID in the code first.");
        return;
      }
      try {
        const loginResp = await msalInstance.loginPopup(loginRequest);
        msalInstance.setActiveAccount(loginResp.account);
        state.msAccount = loginResp.account;
        state.cloudEnabled = true;
        renderSyncStatus();
        await syncFromCloud();
      } catch (e) {
        console.error(e);
        alert("Sign-in failed or was cancelled.");
      }
    }

    async function signOut() {
      if (!msalInstance || !state.msAccount) return;
      try {
        await msalInstance.logoutPopup({ account: state.msAccount });
      } catch (e) {
        console.error(e);
      } finally {
        state.msAccount = null;
        state.cloudEnabled = false;
        renderSyncStatus();
      }
    }

    async function getToken() {
      if (!msalInstance) throw new Error("MSAL not initialized");
      const account = msalInstance.getActiveAccount();
      if (!account) throw new Error("No active account");
      try {
        const resp = await msalInstance.acquireTokenSilent({
          ...loginRequest,
          account
        });
        return resp.accessToken;
      } catch (e) {
        console.warn("Silent token failed, trying popup", e);
        const resp = await msalInstance.acquireTokenPopup(loginRequest);
        return resp.accessToken;
      }
    }

    async function syncFromCloud() {
      if (!state.cloudEnabled) return;
      state.syncing = true;
      renderSyncStatus();
      try {
        const token = await getToken();
        const response = await fetch(`${graphBase}/me/drive/root:/${encodeURIComponent(CLOUD_FILE_NAME)}:/content`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (response.ok) {
          const text = await response.text();
          if (text) {
            const remote = JSON.parse(text);
            if (Array.isArray(remote.entries)) {
              state.entries = remote.entries.map(e => ({ ...e, type: e.type || "expense" }));
              state.lastSyncedAt = remote.lastSyncedAt || new Date().toISOString();
              saveLocalData();
              render();
            }
          }
        }
      } catch (e) {
        console.error("Failed to load from OneDrive", e);
        alert("Could not load data from OneDrive. Check your connection or permissions.");
      } finally {
        state.syncing = false;
        renderSyncStatus();
      }
    }

    async function syncToCloud() {
      if (!state.cloudEnabled) return;
      state.syncing = true;
      renderSyncStatus();
      try {
        const token = await getToken();
        const payload = {
          entries: state.entries,
          lastSyncedAt: new Date().toISOString()
        };
        state.lastSyncedAt = payload.lastSyncedAt;

        const response = await fetch(`${graphBase}/me/drive/root:/${encodeURIComponent(CLOUD_FILE_NAME)}:/content`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error("Upload failed with status " + response.status);
        }
        saveLocalData();
      } catch (e) {
        console.error("Failed to save to OneDrive", e);
        alert("Could not save to OneDrive.");
      } finally {
        state.syncing = false;
        renderSyncStatus();
      }
    }

    function exportBackup() {
      const dataStr = JSON.stringify({
        entries: state.entries,
        lastSyncedAt: state.lastSyncedAt || new Date().toISOString()
      }, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "expense-tracker-backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importBackup(file) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const json = JSON.parse(e.target.result);
          if (Array.isArray(json.entries)) {
            state.entries = json.entries.map(en => ({ ...en, type: en.type || "expense" }));
            state.lastSyncedAt = json.lastSyncedAt || new Date().toISOString();
            saveLocalData();
            render();
            alert("Backup imported successfully.");
          } else {
            alert("Invalid backup file.");
          }
        } catch (err) {
          console.error(err);
          alert("Could not parse backup file.");
        }
      };
      reader.readAsText(file);
    }

    function setupEvents() {
      const monthInput = document.getElementById("monthSelect");
      const today = new Date();
      monthInput.value = today.toISOString().slice(0,7);

      document.getElementById("prevMonthBtn").addEventListener("click", () => {
        const current = new Date(monthInput.value + "-01");
        current.setMonth(current.getMonth() - 1);
        monthInput.value = current.toISOString().slice(0,7);
        render();
      });

      document.getElementById("nextMonthBtn").addEventListener("click", () => {
        const current = new Date(monthInput.value + "-01");
        current.setMonth(current.getMonth() + 1);
        monthInput.value = current.toISOString().slice(0,7);
        render();
      });

      monthInput.addEventListener("change", render);

      document.getElementById("entryForm").addEventListener("submit", e => {
        e.preventDefault();
        const date = document.getElementById("dateInput").value;
        const type = document.getElementById("typeInput").value;
        const category = document.getElementById("categoryInput").value;
        const description = document.getElementById("descriptionInput").value;
        const amount = document.getElementById("amountInput").value;
        if (!date || !amount) return;
        addEntry({ date, type, category, description, amount });
        if (state.cloudEnabled) {
          syncToCloud();
        }
        e.target.reset();
        document.getElementById("dateInput").value = date;
      });

      document.getElementById("signInBtn").addEventListener("click", signIn);
      document.getElementById("signOutBtn").addEventListener("click", signOut);
      document.getElementById("syncNowBtn").addEventListener("click", syncToCloud);
      document.getElementById("exportBtn").addEventListener("click", exportBackup);
      document.getElementById("importBtn").addEventListener("click", () => {
        document.getElementById("importFileInput").click();
      });
      document.getElementById("importFileInput").addEventListener("change", e => {
        const file = e.target.files[0];
        if (file) importBackup(file);
        e.target.value = "";
      });
    }

    window.addEventListener("load", () => {
      loadLocalData();
      setupEvents();
      render();
      initMsal();
    });
  </script>
</body>
</html>
